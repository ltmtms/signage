<!DOCTYPE html>
<html>

<head>
    <title>SJACS 即時電子報告版</title>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@100..900&family=Oswald:wght@200..700&display=swap"
        rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: "Noto Sans HK", sans-serif;
            color: white;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 1.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide {
            text-align: center;
            text-shadow: 2px 2px 4px #000000;
            padding: 20px;
            font-size: 5.5vw;
            line-height: 1.5;
            opacity: 0;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            transform: scale(0.95);
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
        }

        .slide.active {
            opacity: 1;
            transform: scale(1);
        }

        .info-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.1);
        }

        .clock {
            font-size: 3rem;
            text-shadow: 2px 2px 2px #000000;
            font-family: "Oswald", serif;
            font-optical-sizing: auto;
            font-weight: <weight>; /* This should be a numerical value like 400 or a range like 200..700 */
        }

        .counter {
            font-size: 1.5rem;
            text-shadow: 2px 2px 2px #000000;
            font-family: "Oswald", serif;
        }
    </style>
</head>

<body>
    <div class="container" id="container"></div>
    <div class="info-container">
        <div class="clock" id="clock"></div>
        <div class="counter" id="counter"></div>
    </div>

    <div id="buseta"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.7); padding: 20px; border-radius: 10px; width: 80%; max-width: 1200px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
        <button onclick="closeBuseta()"
            style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">X</button>
        <div style="display: flex; justify-content: space-between; gap: 20px;">
            <div style="width: 50%;">
                <h3 style="text-align: center; margin: 0 0 10px 0; color: #333;">聖言巴士站</h3>
                <iframe src="busetaSingYin.html" style="width: 100%; height: 400px; border: none;"></iframe>
            </div>
            <div style="width: 50%;">
                <h3 style="text-align: center; margin: 0 0 10px 0; color: #333;">白虹樓巴士站</h3>
                <iframe src="busetaChoiHung.html" style="width: 100%; height: 400px; border: none;"></iframe>
            </div>
        </div>
    </div>

    <button onclick="toggleBuseta()"
        style="position: fixed; bottom: 50px; right: 10px; padding: 5px; opacity: 0.3; cursor: pointer;">Show Bus
        ETA</button>

    <script>
        const BACKGROUND_IMAGES = [
            'YOUR_BACKGROUND_IMAGE_URL_1.jpg',
            'YOUR_BACKGROUND_IMAGE_URL_2.png',
            'YOUR_BACKGROUND_IMAGE_URL_3.jpeg',
            'YOUR_BACKGROUND_IMAGE_URL_4.gif'
            // Add more image URLs here, or remove if not needed
        ];

        let currentBgIndex = 0;

        function rotateBackground() {
            currentBgIndex = (currentBgIndex + 1) % BACKGROUND_IMAGES.length;
            document.body.style.backgroundImage = `url('${BACKGROUND_IMAGES[currentBgIndex]}')`;
        }

        // Set initial background
        document.body.style.backgroundImage = `url('${BACKGROUND_IMAGES[0]}')`;
        // Start rotation every 16 seconds
        setInterval(rotateBackground, 16000);

        function toggleBuseta() {
            const buseta = document.getElementById('buseta');
            buseta.style.display = buseta.style.display === 'none' ? 'block' : 'none';
        }

        function closeBuseta() {
            document.getElementById('buseta').style.display = 'none';
        }

        function checkBusetaTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            const buseta = document.getElementById('buseta');
            const currentTime = currentHour * 100 + currentMinutes;

            // Display buseta between 15:45 and 22:00
            if (currentTime >= 1545 && currentTime < 2200) {
                buseta.style.display = 'block';
            } else {
                buseta.style.display = 'none';
            }
        }

        // Check time every minute
        setInterval(checkBusetaTime, 60000);
        // Initial check
        checkBusetaTime();

        // **IMPORTANT: Replace this with your Google Sheet's PUBLISHED CSV link**
        // To get this link: Go to your Google Sheet -> File -> Share -> Publish to web -> Link -> CSV -> Publish
        const GOOGLE_SHEET_CSV_URL = 'YOUR_GOOGLE_SHEET_PUBLISHED_CSV_LINK_HERE'; 

        let currentSlide = 0;
        let slides = [];

        // Clear old intervals when setting new ones to prevent multiple intervals running
        function setIntervalWithCleanup(callback, delay) {
            const oldInterval = window[callback.name + 'Interval'];
            if (oldInterval) clearInterval(oldInterval);
            window[callback.name + 'Interval'] = setInterval(callback, delay);
            return window[callback.name + 'Interval'];
        }

        async function loadAndUpdateSlides() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                const data = await response.text();
                const rows = data.split('\n').slice(1); // Skip header row
                const now = new Date();
                const today = now.toLocaleDateString('en-HK', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                const filteredData = rows.filter(row => {
                    const columns = row.split(',');
                    // Assuming date is in column 5 (index 4) and needs to be cleaned of quotes
                    return columns[4] && columns[4].replace(/"/g, '').trim() === today;
                });

                const container = document.getElementById('container');
                container.innerHTML = ''; // Clear existing slides

                if (filteredData.length === 0) {
                    container.innerHTML = '<div class="slide active">今日無待顯示公告</div>';
                    // Clear any existing slide rotation interval if no slides
                    clearInterval(window.rotateSlidesInterval);
                    document.getElementById('counter').textContent = `0 of 0`;
                    return;
                }

                slides = filteredData.map(row => {
                    const columns = row.split(',');
                    const div = document.createElement('div');
                    div.className = 'slide';
                    // Assuming content is in columns 2, 3, 4 (indices 1, 2, 3)
                    div.innerHTML = [columns[1], columns[2], columns[3]].map(i => i ? i.replace(/"/g, '') : '').join('<br>');
                    container.appendChild(div);
                    return div;
                });

                currentSlide = 0;
                setTimeout(() => {
                    slides[0].classList.add('active');
                    document.getElementById('counter').textContent = `1 of ${slides.length}`;
                }, 1200); // Allow for initial fade-in

                // Restart slide rotation interval after loading new slides
                setIntervalWithCleanup(rotateSlides, 8000);

            } catch (error) {
                console.error('Data loading failed:', error);
                const container = document.getElementById('container');
                container.innerHTML = '<div class="slide active">載入失敗</div>';
                clearInterval(window.rotateSlidesInterval); // Stop rotation on error
                document.getElementById('counter').textContent = `0 of 0`;
            }
        }

        async function rotateSlides() {
            if (slides.length <= 1) {
                // If only one or no slides, keep it displayed and don't rotate
                // If there are no slides, loadAndUpdateSlides should have handled it.
                // If there's 1 slide, just ensure it's active and counter is correct.
                if (slides.length === 1 && !slides[0].classList.contains('active')) {
                    slides[0].classList.add('active');
                    document.getElementById('counter').textContent = `1 of 1`;
                }
                return;
            }

            // Remove active class from current slide with transition
            const currentElement = slides[currentSlide];
            if (currentElement) { // Ensure element exists before trying to manipulate
                currentElement.classList.remove('active');
            }


            // Wait for transition to complete
            await new Promise(resolve => setTimeout(resolve, 1200));

            // Check if it's the last slide
            const isLastSlide = currentSlide === slides.length - 1;
            if (isLastSlide) {
                // If it's the last slide, wait a bit longer, then reload all slides
                await new Promise(resolve => setTimeout(resolve, 1500));
                const container = document.getElementById('container');
                container.innerHTML = ''; // Clear all slides before reloading
                await loadAndUpdateSlides(); // Re-fetch and re-render slides
                return; // Exit to let new slides initialize and set their own interval
            }

            // Move to next slide
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
            document.getElementById('counter').textContent = `${currentSlide + 1} of ${slides.length}`;
        }

        function updateClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                weekday: 'long',
                year: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-HK', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('clock').textContent = `${timeStr}, ${dateStr} `;
        }

        async function initialize() {
            await loadAndUpdateSlides();
            setIntervalWithCleanup(updateClock, 1000);
            updateClock(); // Initial clock display
        }

        async function fetchRSSNews() {
            try {
                // Using AllOrigins as a CORS proxy for the RSS feed
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const rssUrl = 'https://rthk.hk/rthk/news/rss/c_expressnews_clocal.xml';
                const response = await fetch(proxyUrl + encodeURIComponent(rssUrl));
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                const items = xmlDoc.getElementsByTagName('item');

                let newsText = '望德不叫人蒙羞，因為天主的愛，藉著所賜與我們的聖神，已傾注在我們心中了。——羅馬書5:5 || 香港電台本地新聞：';
                for (let i = 0; i < items.length; i++) {
                    const title = items[i].getElementsByTagName('title')[0].textContent;
                    newsText += title + ' || ';
                }
                document.getElementById('rss-content').textContent = newsText;
            } catch (error) {
                console.error('Error fetching RSS:', error);
                document.getElementById('rss-content').textContent = '未能載入新聞。'; // Display error message
            }
        }

        initialize();
        fetchRSSNews();
        // Update RSS news every 5 minutes (300000 ms)
        setInterval(fetchRSSNews, 300000);

        // Auto refresh page every 15 minutes (900000 milliseconds)
        setIntervalWithCleanup(() => {
            window.location.reload();
        }, 900000);
    </script>
    <div id="rss-container"
        style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; padding: 10px; height: 30px; overflow: hidden; font-size: 20px; display: block;">
        <marquee behavior="scroll" direction="left" scrollamount="6" id="rss-content"></marquee>
    </div>

</body>
</html>
